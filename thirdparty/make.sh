# Author: Carlos Pe√±a-Monferrer (SIMZERO) - 2023
#!/bin/bash

PROC=6
ROOT=/build
BUILD_ROOT=$ROOT/thirdparty

if [[ -v CORES && -n "${CORES}" ]]; then
  PROC=${CORES}
fi

echo "#############################"
echo  BUILDING VTK
echo "#############################"

VTK_ROOT=$BUILD_ROOT/vtk
VTK_BUILD=$BUILD_ROOT/vtk/vtk-wasm
VTK_VERSION=v9.2.0
VTK_LIB_VERSION=9.2

if [ ! -d $VTK_BUILD  ];then
  mkdir -p $VTK_BUILD
fi

sed -i 's/VTK_USE_PTHREADS 1/VTK_USE_PTHREADS 0/g' ${VTK_ROOT}/Common/Core/CMakeLists.txt

cd $VTK_BUILD

emcmake cmake \
  -GNinja \
  -DCMAKE_TOOLCHAIN_FILE=${CMAKE_TOOLCHAIN_FILE} \
  -DVTK_BUILD_DOCUMENTATION=NO \
  -DVTK_BUILD_TESTING=OFF \
  -DVTK_GROUP_ENABLE_Imaging=DONT_WANT \
  -DVTK_GROUP_ENABLE_MPI=DONT_WANT \
  -DVTK_GROUP_ENABLE_Qt=DONT_WANT \
  -DVTK_GROUP_ENABLE_Rendering=WANT \
  -DVTK_GROUP_ENABLE_StandAlone=WANT \
  -DVTK_GROUP_ENABLE_Views=DONT_WANT \
  -DVTK_GROUP_ENABLE_Web=DONT_WANT \
  -DVTK_USE_PTHREADS:BOOL=OFF \
  -DBUILD_SHARED_LIBS:BOOL=OFF \
  -DCMAKE_BUILD_TYPE:STRING=Release \
  -DVTK_OPENGL_USE_GLES:BOOL=ON \
  -DVTK_USE_SDL2:BOOL=ON \
  -DVTK_ENABLE_LOGGING:BOOL=OFF \
  -DVTK_ENABLE_WRAPPING:BOOL=OFF \
  -DVTK_MODULE_ENABLE_VTK_hdf5:STRING=NO \
  -DVTK_MODULE_ENABLE_VTK_libproj=NO \
  -DVTK_MODULE_ENABLE_VTK_RenderingContextOpenGL2:STRING=DONT_WANT \
  -DVTK_MODULE_ENABLE_VTK_RenderingContext2D=DONT_WANT \
  -DVTK_NO_PLATFORM_SOCKETS:BOOL=ON \
  -DVTK_MODULE_ENABLE_VTK_RenderingLICOpenGL2:STRING=DONT_WANT \
  -DVTK_MODULE_ENABLE_VTK_sqlite:STRING=NO \
  ..

cmake --build $VTK_BUILD --parallel $PROC
